<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polinomios 4¬∫ ESO - Pr√°ctica Interactiva</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        @media print {
            .no-print { display: none !important; }
        }
        .frac {
            display: inline-flex;
            flex-direction: column;
            vertical-align: middle;
            text-align: center;
            margin: 0 3px;
            font-size: 0.95em;
        }
        .frac .top {
            border-bottom: 1.5px solid currentColor;
            padding: 0 5px 2px 5px;
            line-height: 1.2;
        }
        .frac .bottom {
            padding: 2px 5px 0 5px;
            line-height: 1.2;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script>
        // ============================================
        // DATOS COMPLETOS DE EJERCICIOS
        // ============================================
        
        const exerciseData = {
            // BLOQUE 1: VALOR NUM√âRICO
            "1-1.1": [
                { q: "Si P(x) = 2x¬≤ + 3x - 1, calcula P(2)", a: "13", sol: "P(2) = 2(2)¬≤ + 3(2) - 1 = 2(4) + 6 - 1 = 8 + 6 - 1 = 13" },
                { q: "Si P(x) = x¬≤ - 4x + 3, calcula P(1)", a: "0", sol: "P(1) = (1)¬≤ - 4(1) + 3 = 1 - 4 + 3 = 0" },
                { q: "Si Q(x) = 3x¬≤ + 2x - 5, calcula Q(0)", a: "-5", sol: "Q(0) = 3(0)¬≤ + 2(0) - 5 = 0 + 0 - 5 = -5" },
                { q: "Si P(x) = x¬≤ + 5x + 6, calcula P(-1)", a: "2", sol: "P(-1) = (-1)¬≤ + 5(-1) + 6 = 1 - 5 + 6 = 2" },
                { q: "Si P(x) = 4x¬≤ + x - 2, calcula P(3)", a: "37", sol: "P(3) = 4(3)¬≤ + 1(3) - 2 = 4(9) + 3 - 2 = 36 + 3 - 2 = 37" },
                { q: "Si Q(x) = -2x¬≤ + 5x - 3, calcula Q(2)", a: "-1", sol: "Q(2) = -2(2)¬≤ + 5(2) - 3 = -8 + 10 - 3 = -1" },
                { q: "Si P(x) = x¬≤ - 6x + 9, calcula P(3)", a: "0", sol: "P(3) = (3)¬≤ - 6(3) + 9 = 9 - 18 + 9 = 0" }
            ],
            "1-1.2": [
                { q: "Si P(x) = x¬≥ + 2x¬≤ - x + 1, calcula P(1)", a: "3", sol: "P(1) = (1)¬≥ + 2(1)¬≤ - 1 + 1 = 1 + 2 - 1 + 1 = 3" },
                { q: "Si Q(x) = 2x¬≥ - 3x¬≤ + 4x - 5, calcula Q(-1)", a: "-14", sol: "Q(-1) = 2(-1)¬≥ - 3(-1)¬≤ + 4(-1) - 5 = -2 - 3 - 4 - 5 = -14" },
                { q: "Si P(x) = x¬≥ - 6x¬≤ + 9x, calcula P(3)", a: "0", sol: "P(3) = (3)¬≥ - 6(3)¬≤ + 9(3) = 27 - 54 + 27 = 0" },
                { q: "Si P(x) = 3x¬≥ - 2x + 4, calcula P(2)", a: "24", sol: "P(2) = 3(2)¬≥ - 2(2) + 4 = 24 - 4 + 4 = 24" },
                { q: "Si Q(x) = x¬≥ - 8, calcula Q(2)", a: "0", sol: "Q(2) = (2)¬≥ - 8 = 8 - 8 = 0" },
                { q: "Si P(x) = -x¬≥ + 3x¬≤ - x + 2, calcula P(2)", a: "4", sol: "P(2) = -(2)¬≥ + 3(2)¬≤ - 2 + 2 = -8 + 12 - 2 + 2 = 4" }
            ],
            "1-1.3": [
                { q: "Si P(x) = -2x¬≤ + 3x - 1, calcula P(2)", a: "-3", sol: "P(2) = -2(2)¬≤ + 3(2) - 1 = -8 + 6 - 1 = -3" },
                { q: "Si Q(x) = -3x¬≤ - 4x + 7, calcula Q(-1)", a: "8", sol: "Q(-1) = -3(-1)¬≤ - 4(-1) + 7 = -3 + 4 + 7 = 8" },
                { q: "Si P(x) = -x¬≥ + 2x¬≤ - x + 5, calcula P(-1)", a: "9", sol: "P(-1) = -(-1)¬≥ + 2(-1)¬≤ - (-1) + 5 = 1 + 2 + 1 + 5 = 9" },
                { q: "Si R(x) = -5x¬≤ + 10x - 3, calcula R(2)", a: "-3", sol: "R(2) = -5(2)¬≤ + 10(2) - 3 = -20 + 20 - 3 = -3" },
                { q: "Si P(x) = -3x¬≤ - 2x + 5, calcula P(0)", a: "5", sol: "P(0) = 5" },
                { q: "Si Q(x) = -2x¬≥ - 3x¬≤ + 4x - 1, calcula Q(1)", a: "-2", sol: "Q(1) = -2(1)¬≥ - 3(1)¬≤ + 4(1) - 1 = -2 - 3 + 4 - 1 = -2" },
                { q: "Si P(x) = -4x¬≤ + 8x - 3, calcula P(-1)", a: "-15", sol: "P(-1) = -4(-1)¬≤ + 8(-1) - 3 = -4 - 8 - 3 = -15" }
            ],
            "1-1.4": [
                { q: "Si P(x) = x‚Å¥ - 2x¬≥ + 3x¬≤ - x + 1, calcula P(1)", a: "2", sol: "P(1) = 1 - 2 + 3 - 1 + 1 = 2" },
                { q: "Si Q(x) = 2x‚Å¥ + x¬≥ - 5x¬≤ + 3x - 7, calcula Q(-1)", a: "-14", sol: "Q(-1) = 2(-1)‚Å¥ + (-1)¬≥ - 5(-1)¬≤ + 3(-1) - 7 = 2 - 1 - 5 - 3 - 7 = -14" },
                { q: "Si R(x) = 3x‚Å¥ - 2x¬≤ + 1, calcula R(2)", a: "41", sol: "R(2) = 3(16) - 2(4) + 1 = 48 - 8 + 1 = 41" },
                { q: "Si P(x) = -x‚Å¥ + 4x¬≥ - 6x¬≤ + 4x - 1, calcula P(1)", a: "0", sol: "P(1) = -1 + 4 - 6 + 4 - 1 = 0" },
                { q: "Si Q(x) = x‚Åµ - x¬≥ + x, calcula Q(-1)", a: "-1", sol: "Q(-1) = (-1)‚Åµ - (-1)¬≥ + (-1) = -1 - (-1) - 1 = -1" },
                { q: "Si P(x) = (1/2)x‚Å¥ - 3x¬≤ + 2, calcula P(2)", a: "-2", sol: "P(2) = (1/2)(16) - 3(4) + 2 = 8 - 12 + 2 = -2" }
            ],
            // NUEVO: Valor num√©rico con fracciones positivas y negativas
            "1-1.5": [
                { q: "Si P(x) = 4x¬≤ - 8x + 3, calcula P(1/2)", a: "0", sol: "P(1/2) = 4(1/2)¬≤ - 8(1/2) + 3 = 4(1/4) - 4 + 3 = 1 - 4 + 3 = 0" },
                { q: "Si Q(x) = 2x¬≤ + 3x - 1, calcula Q(-1/2)", a: "-2", sol: "Q(-1/2) = 2(-1/2)¬≤ + 3(-1/2) - 1 = 2(1/4) - 3/2 - 1 = 1/2 - 3/2 - 1 = -2" },
                { q: "Si P(x) = 9x¬≤ - 6x + 1, calcula P(1/3)", a: "0", sol: "P(1/3) = 9(1/3)¬≤ - 6(1/3) + 1 = 9(1/9) - 2 + 1 = 1 - 2 + 1 = 0" },
                { q: "Si Q(x) = -4x¬≤ + 4x - 1, calcula Q(1/2)", a: "0", sol: "Q(1/2) = -4(1/2)¬≤ + 4(1/2) - 1 = -4(1/4) + 2 - 1 = -1 + 2 - 1 = 0" },
                { q: "Si P(x) = 3x¬≤ - 5x + 2, calcula P(2/3)", a: "0", sol: "P(2/3) = 3(2/3)¬≤ - 5(2/3) + 2 = 3(4/9) - 10/3 + 2 = 4/3 - 10/3 + 6/3 = 0" },
                { q: "Si Q(x) = 8x¬≥ - 12x¬≤ + 6x - 1, calcula Q(1/2)", a: "0", sol: "Q(1/2) = 8(1/8) - 12(1/4) + 6(1/2) - 1 = 1 - 3 + 3 - 1 = 0" },
                { q: "Si P(x) = 6x¬≤ + 7x - 3, calcula P(-3/2)", a: "0", sol: "P(-3/2) = 6(9/4) + 7(-3/2) - 3 = 27/2 - 21/2 - 6/2 = 0" },
                { q: "Si Q(x) = 27x¬≥ - 27x¬≤ + 9x - 1, calcula Q(1/3)", a: "0", sol: "Q(1/3) = 27(1/27) - 27(1/9) + 9(1/3) - 1 = 1 - 3 + 3 - 1 = 0" }
            ],

            // BLOQUE 2: SUMA Y RESTA
            "2-2.1": [
                { q: "Suma: (3x¬≤ - 2x + 5) + (x¬≤ + 4x - 3)", a: "4x¬≤+2x+2", sol: "(3+1)x¬≤ + (-2+4)x + (5-3) = 4x¬≤ + 2x + 2" },
                { q: "Suma: (2x¬≥ - x¬≤ + 3x) + (-x¬≥ + 3x¬≤ - 2x + 1)", a: "x¬≥+2x¬≤+x+1", sol: "(2-1)x¬≥ + (-1+3)x¬≤ + (3-2)x + 1 = x¬≥ + 2x¬≤ + x + 1" },
                { q: "Resta: (5x¬≤ + 3x - 7) - (2x¬≤ - x + 4)", a: "3x¬≤+4x-11", sol: "5x¬≤ + 3x - 7 - 2x¬≤ + x - 4 = 3x¬≤ + 4x - 11" },
                { q: "Suma: (x¬≥/2 + x¬≤) + (x¬≥/2 - 3x¬≤)", a: "x¬≥-2x¬≤", sol: "x¬≥/2 + x¬≤ + x¬≥/2 - 3x¬≤ = (1/2 + 1/2)x¬≥ + (1 - 3)x¬≤ = x¬≥ - 2x¬≤" },
                { q: "Resta: (4x¬≥ - 2x¬≤ + x - 5) - (x¬≥ + x¬≤ - 3x + 2)", a: "3x¬≥-3x¬≤+4x-7", sol: "4x¬≥ - 2x¬≤ + x - 5 - x¬≥ - x¬≤ + 3x - 2 = 3x¬≥ - 3x¬≤ + 4x - 7" },
                { q: "Si P(x) = 3x¬≤ - x + 2 y Q(x) = -x¬≤ + 4x - 1, calcula P(x) + Q(x)", a: "2x¬≤+3x+1", sol: "(3-1)x¬≤ + (-1+4)x + (2-1) = 2x¬≤ + 3x + 1" }
            ],
            "2-2.2": [
                { q: "Si P(x) = 2x¬≤ - 3x + 1 y Q(x) = x¬≤ + 2x - 4, calcula P(x) - Q(x)", a: "x¬≤-5x+5", sol: "(2-1)x¬≤ + (-3-2)x + (1-(-4)) = x¬≤ - 5x + 5" },
                { q: "Calcula: (x¬≥ - 2x¬≤) - (x¬≥ + x¬≤ - 3x) + (4x¬≤ + x)", a: "x¬≤+4x", sol: "x¬≥ - 2x¬≤ - x¬≥ - x¬≤ + 3x + 4x¬≤ + x = x¬≤ + 4x" },
                { q: "Si P(x) = (1/2)x¬≤ + 3x - 1 y Q(x) = (3/2)x¬≤ - x + 2, calcula P(x) + Q(x)", a: "2x¬≤+2x+1", sol: "(1/2 + 3/2)x¬≤ + (3-1)x + (-1+2) = 2x¬≤ + 2x + 1" },
                { q: "Simplifica: [(2x¬≤ + x) - (x¬≤ - 3x)] + (x¬≤ + 2x)", a: "2x¬≤+6x", sol: "Primero: 2x¬≤ + x - x¬≤ + 3x = x¬≤ + 4x. Luego: x¬≤ + 4x + x¬≤ + 2x = 2x¬≤ + 6x" },
                { q: "Si P(x) = x¬≥ - 2x + 5, Q(x) = 2x¬≥ + x¬≤ - 3, calcula 2P(x) - Q(x)", a: "-x¬≤-4x+13", sol: "2(x¬≥ - 2x + 5) - (2x¬≥ + x¬≤ - 3) = 2x¬≥ - 4x + 10 - 2x¬≥ - x¬≤ + 3 = -x¬≤ - 4x + 13" }
            ],
            "2-2.3": [
                { q: "Si P(x) = 2x¬≤ - x + 3, Q(x) = x¬≤ + 2x - 1, R(x) = -x¬≤ + x + 2, calcula P(x) + Q(x) - R(x)", a: "4x¬≤", sol: "2x¬≤ - x + 3 + x¬≤ + 2x - 1 - (-x¬≤ + x + 2) = 4x¬≤" },
                { q: "Calcula: (x¬≥ - (1/2)x¬≤ + 2) - (x¬≥/2 + x¬≤ - 3)", a: "x¬≥/2-3x¬≤/2+5", sol: "(1 - 1/2)x¬≥ + (-1/2 - 1)x¬≤ + (2+3) = (1/2)x¬≥ - (3/2)x¬≤ + 5" },
                { q: "Si P(x) = 3x¬≥ - 2x¬≤ + x, Q(x) = x¬≥ + x¬≤ - 4x, calcula P(x) - 2Q(x)", a: "x¬≥-4x¬≤+9x", sol: "3x¬≥ - 2x¬≤ + x - 2(x¬≥ + x¬≤ - 4x) = x¬≥ - 4x¬≤ + 9x" },
                { q: "Resta: [(2x¬≥ + x¬≤) - (x¬≥ - 2x¬≤)] - (x¬≥ + x¬≤ - 1)", a: "2x¬≤+1", sol: "Primero: 2x¬≥ + x¬≤ - x¬≥ + 2x¬≤ = x¬≥ + 3x¬≤. Luego: x¬≥ + 3x¬≤ - x¬≥ - x¬≤ + 1 = 2x¬≤ + 1" },
                { q: "Calcula: 3(x¬≤ - x + 1) - 2(2x¬≤ + x - 2)", a: "-x¬≤-5x+7", sol: "3x¬≤ - 3x + 3 - 4x¬≤ - 2x + 4 = -x¬≤ - 5x + 7" }
            ],
            "2-2.4": [
                { q: "Si P(x) = x¬≥ - 2x¬≤ + 3x - 1, Q(x) = 2x¬≥ + x¬≤ - x + 2, R(x) = -x¬≥ + 3x¬≤ - 2, calcula P(x) - Q(x) + 2R(x)", a: "-3x¬≥+3x¬≤+4x-7", sol: "(1-2+2(-1))x¬≥ + (-2-1+2(3))x¬≤ + (3-(-1))x + (-1-2+2(-2)) = -3x¬≥ + 3x¬≤ + 4x - 7" },
                { q: "Calcula: 2(x¬≤ - 3x + 1) - [3(x¬≤ + x) - (2x¬≤ - x - 5)]", a: "x¬≤-10x-3", sol: "2x¬≤ - 6x + 2 - [3x¬≤ + 3x - 2x¬≤ + x + 5] = x¬≤ - 10x - 3" },
                { q: "Si P(x) = (1/2)x¬≥ - x¬≤ + 2x, Q(x) = x¬≥ + (1/2)x¬≤ - x, R(x) = -x¬≥ + x¬≤ + 3, calcula P(x) + 2Q(x) - R(x)", a: "7x¬≥/2-x¬≤-3", sol: "(1/2 + 2 - (-1))x¬≥ + (-1 + 2(1/2) - 1)x¬≤ + (2 + 2(-1))x - 3 = (7/2)x¬≥ - x¬≤ - 3" },
                { q: "Calcula: (1/3)[3x¬≥ - 6x¬≤ + 9x] - (1/2)[2x¬≥ - 4x + 6]", a: "-2x¬≤+5x-3", sol: "x¬≥ - 2x¬≤ + 3x - x¬≥ + 2x - 3 = -2x¬≤ + 5x - 3" }
            ],

            // BLOQUE 3: MULTIPLICACI√ìN
            "3-3.1": [
                { q: "Multiplica: 2x ¬∑ 5x", a: "10x¬≤", sol: "2x ¬∑ 5x = 10x¬≤" },
                { q: "Multiplica: 4x¬≤ ¬∑ 3x", a: "12x¬≥", sol: "4x¬≤ ¬∑ 3x = 12x¬≥" },
                { q: "Multiplica: (-2x) ¬∑ 6x¬≤", a: "-12x¬≥", sol: "(-2x) ¬∑ 6x¬≤ = -12x¬≥" },
                { q: "Multiplica: 8x¬≥ ¬∑ (-3x)", a: "-24x‚Å¥", sol: "8x¬≥ ¬∑ (-3x) = -24x‚Å¥" },
                { q: "Multiplica: (-x¬≤) ¬∑ (-7x)", a: "7x¬≥", sol: "(-x¬≤) ¬∑ (-7x) = 7x¬≥" },
                { q: "Multiplica: 3xy ¬∑ 4x¬≤y", a: "12x¬≥y¬≤", sol: "3xy ¬∑ 4x¬≤y = 12x¬≥y¬≤" }
            ],
            "3-3.2": [
                { q: "Multiplica: 2x(x + 3)", a: "2x¬≤+6x", sol: "2x ¬∑ x + 2x ¬∑ 3 = 2x¬≤ + 6x" },
                { q: "Multiplica: 3x(2x - 5)", a: "6x¬≤-15x", sol: "3x ¬∑ 2x + 3x ¬∑ (-5) = 6x¬≤ - 15x" },
                { q: "Multiplica: -2x(x¬≤ + 3x - 1)", a: "-2x¬≥-6x¬≤+2x", sol: "-2x ¬∑ x¬≤ + (-2x) ¬∑ 3x + (-2x) ¬∑ (-1) = -2x¬≥ - 6x¬≤ + 2x" },
                { q: "Multiplica: 4x¬≤(x - 2)", a: "4x¬≥-8x¬≤", sol: "4x¬≤ ¬∑ x + 4x¬≤ ¬∑ (-2) = 4x¬≥ - 8x¬≤" },
                { q: "Multiplica: x(x¬≤ - 4x + 3)", a: "x¬≥-4x¬≤+3x", sol: "x ¬∑ x¬≤ + x ¬∑ (-4x) + x ¬∑ 3 = x¬≥ - 4x¬≤ + 3x" }
            ],
            "3-3.3": [
                { q: "Multiplica: (x + 3)(x + 4)", a: "x¬≤+7x+12", sol: "x¬≤ + 4x + 3x + 12 = x¬≤ + 7x + 12" },
                { q: "Multiplica: (x - 2)(x + 5)", a: "x¬≤+3x-10", sol: "x¬≤ + 5x - 2x - 10 = x¬≤ + 3x - 10" },
                { q: "Multiplica: (2x + 1)(x - 3)", a: "2x¬≤-5x-3", sol: "2x¬≤ - 6x + x - 3 = 2x¬≤ - 5x - 3" },
                { q: "Multiplica: (x - 6)(x - 2)", a: "x¬≤-8x+12", sol: "x¬≤ - 2x - 6x + 12 = x¬≤ - 8x + 12" },
                { q: "Multiplica: (3x + 2)(2x - 3)", a: "6x¬≤-5x-6", sol: "6x¬≤ - 9x + 4x - 6 = 6x¬≤ - 5x - 6" }
            ],
            "3-3.4": [
                { q: "Multiplica: (x¬≤ + x)(x - 2)", a: "x¬≥-x¬≤-2x", sol: "x¬≤¬∑x + x¬≤¬∑(-2) + x¬∑x + x¬∑(-2) = x¬≥ - x¬≤ - 2x" },
                { q: "Multiplica: (x + 2)(x¬≤ - x + 3)", a: "x¬≥+x¬≤+x+6", sol: "x¬≥ - x¬≤ + 3x + 2x¬≤ - 2x + 6 = x¬≥ + x¬≤ + x + 6" },
                { q: "Multiplica: (2x - 1)(x¬≤ + 2x - 3)", a: "2x¬≥+3x¬≤-8x+3", sol: "2x¬≥ + 4x¬≤ - 6x - x¬≤ - 2x + 3 = 2x¬≥ + 3x¬≤ - 8x + 3" },
                { q: "Multiplica: (x¬≤ - 3)(x¬≤ + 2)", a: "x‚Å¥-x¬≤-6", sol: "x‚Å¥ + 2x¬≤ - 3x¬≤ - 6 = x‚Å¥ - x¬≤ - 6" },
                { q: "Multiplica: (x - 1)(x + 1)(x + 3)", a: "x¬≥+3x¬≤-x-3", sol: "Primero: (x-1)(x+1) = x¬≤-1. Luego: (x¬≤-1)(x+3) = x¬≥+3x¬≤-x-3" }
            ],

            // BLOQUE 4: IDENTIDADES NOTABLES
            "4-4.1": [
                { q: "Desarrolla: (x + 3)¬≤", a: "x¬≤+6x+9", sol: "(x+3)¬≤ = x¬≤ + 2¬∑x¬∑3 + 3¬≤ = x¬≤ + 6x + 9" },
                { q: "Desarrolla: (2x + 5)¬≤", a: "4x¬≤+20x+25", sol: "(2x+5)¬≤ = 4x¬≤ + 20x + 25" },
                { q: "Desarrolla: (3x + 1)¬≤", a: "9x¬≤+6x+1", sol: "(3x+1)¬≤ = 9x¬≤ + 6x + 1" },
                { q: "Desarrolla: (x + 2y)¬≤", a: "x¬≤+4xy+4y¬≤", sol: "(x+2y)¬≤ = x¬≤ + 4xy + 4y¬≤" },
                { q: "Desarrolla: (2a + 3b)¬≤", a: "4a¬≤+12ab+9b¬≤", sol: "(2a+3b)¬≤ = 4a¬≤ + 12ab + 9b¬≤" },
                // NUEVO: Con fracciones y varias letras
                { q: "Desarrolla: (x/2 + y/3)¬≤", a: "x¬≤/4+xy/3+y¬≤/9", sol: "(x/2)¬≤ + 2(x/2)(y/3) + (y/3)¬≤ = x¬≤/4 + xy/3 + y¬≤/9" },
                { q: "Desarrolla: (2a¬≤b/3 + c/2)¬≤", a: "4a‚Å¥b¬≤/9+2a¬≤bc/3+c¬≤/4", sol: "(2a¬≤b/3)¬≤ + 2(2a¬≤b/3)(c/2) + (c/2)¬≤ = 4a‚Å¥b¬≤/9 + 2a¬≤bc/3 + c¬≤/4" },
                { q: "Desarrolla: (3xy/4 + 2z¬≤/5)¬≤", a: "9x¬≤y¬≤/16+3xyz¬≤/5+4z‚Å¥/25", sol: "(3xy/4)¬≤ + 2(3xy/4)(2z¬≤/5) + (2z¬≤/5)¬≤ = 9x¬≤y¬≤/16 + 3xyz¬≤/5 + 4z‚Å¥/25" },
                { q: "Desarrolla: (ab/2 + cd/3)¬≤", a: "a¬≤b¬≤/4+abcd/3+c¬≤d¬≤/9", sol: "(ab/2)¬≤ + 2(ab/2)(cd/3) + (cd/3)¬≤ = a¬≤b¬≤/4 + abcd/3 + c¬≤d¬≤/9" }
            ],
            "4-4.2": [
                { q: "Desarrolla: (x - 4)¬≤", a: "x¬≤-8x+16", sol: "(x-4)¬≤ = x¬≤ - 8x + 16" },
                { q: "Desarrolla: (3x - 2)¬≤", a: "9x¬≤-12x+4", sol: "(3x-2)¬≤ = 9x¬≤ - 12x + 4" },
                { q: "Desarrolla: (2x - 5)¬≤", a: "4x¬≤-20x+25", sol: "(2x-5)¬≤ = 4x¬≤ - 20x + 25" },
                { q: "Desarrolla: (x - 3y)¬≤", a: "x¬≤-6xy+9y¬≤", sol: "(x-3y)¬≤ = x¬≤ - 6xy + 9y¬≤" },
                { q: "Desarrolla: (2a - b)¬≤", a: "4a¬≤-4ab+b¬≤", sol: "(2a-b)¬≤ = 4a¬≤ - 4ab + b¬≤" },
                // NUEVO: Con fracciones y varias letras
                { q: "Desarrolla: (a/3 - b/4)¬≤", a: "a¬≤/9-ab/6+b¬≤/16", sol: "(a/3)¬≤ - 2(a/3)(b/4) + (b/4)¬≤ = a¬≤/9 - ab/6 + b¬≤/16" },
                { q: "Desarrolla: (3x¬≤y/5 - 2z/3)¬≤", a: "9x‚Å¥y¬≤/25-4x¬≤yz/5+4z¬≤/9", sol: "(3x¬≤y/5)¬≤ - 2(3x¬≤y/5)(2z/3) + (2z/3)¬≤ = 9x‚Å¥y¬≤/25 - 4x¬≤yz/5 + 4z¬≤/9" },
                { q: "Desarrolla: (2ab¬≤/3 - c¬≤d/4)¬≤", a: "4a¬≤b‚Å¥/9-ab¬≤c¬≤d/3+c‚Å¥d¬≤/16", sol: "(2ab¬≤/3)¬≤ - 2(2ab¬≤/3)(c¬≤d/4) + (c¬≤d/4)¬≤ = 4a¬≤b‚Å¥/9 - ab¬≤c¬≤d/3 + c‚Å¥d¬≤/16" },
                { q: "Desarrolla: (xy/2 - 3z¬≤/4)¬≤", a: "x¬≤y¬≤/4-3xyz¬≤/4+9z‚Å¥/16", sol: "(xy/2)¬≤ - 2(xy/2)(3z¬≤/4) + (3z¬≤/4)¬≤ = x¬≤y¬≤/4 - 3xyz¬≤/4 + 9z‚Å¥/16" }
            ],
            "4-4.3": [
                { q: "Multiplica: (x + 5)(x - 5)", a: "x¬≤-25", sol: "(x+5)(x-5) = x¬≤ - 25" },
                { q: "Multiplica: (3x + 2)(3x - 2)", a: "9x¬≤-4", sol: "(3x+2)(3x-2) = 9x¬≤ - 4" },
                { q: "Multiplica: (2x + 7)(2x - 7)", a: "4x¬≤-49", sol: "(2x+7)(2x-7) = 4x¬≤ - 49" },
                { q: "Multiplica: (x + 2y)(x - 2y)", a: "x¬≤-4y¬≤", sol: "(x+2y)(x-2y) = x¬≤ - 4y¬≤" },
                { q: "Multiplica: (3a + 4b)(3a - 4b)", a: "9a¬≤-16b¬≤", sol: "(3a+4b)(3a-4b) = 9a¬≤ - 16b¬≤" },
                // NUEVO: Con fracciones y varias letras
                { q: "Multiplica: (x/2 + y/3)(x/2 - y/3)", a: "x¬≤/4-y¬≤/9", sol: "(x/2 + y/3)(x/2 - y/3) = (x/2)¬≤ - (y/3)¬≤ = x¬≤/4 - y¬≤/9" },
                { q: "Multiplica: (2a¬≤b/3 + c/5)(2a¬≤b/3 - c/5)", a: "4a‚Å¥b¬≤/9-c¬≤/25", sol: "(2a¬≤b/3)¬≤ - (c/5)¬≤ = 4a‚Å¥b¬≤/9 - c¬≤/25" },
                { q: "Multiplica: (3xy¬≤/4 + 2z/3)(3xy¬≤/4 - 2z/3)", a: "9x¬≤y‚Å¥/16-4z¬≤/9", sol: "(3xy¬≤/4)¬≤ - (2z/3)¬≤ = 9x¬≤y‚Å¥/16 - 4z¬≤/9" },
                { q: "Multiplica: (ab/2 + cd¬≤/3)(ab/2 - cd¬≤/3)", a: "a¬≤b¬≤/4-c¬≤d‚Å¥/9", sol: "(ab/2)¬≤ - (cd¬≤/3)¬≤ = a¬≤b¬≤/4 - c¬≤d‚Å¥/9" }
            ],
            "4-4.4": [
                { q: "Desarrolla: (x + 2)¬≤ - (x - 2)¬≤", a: "8x", sol: "(x¬≤+4x+4) - (x¬≤-4x+4) = 8x" },
                { q: "Calcula: (2x + 3)¬≤ - (2x - 3)¬≤", a: "24x", sol: "(4x¬≤+12x+9) - (4x¬≤-12x+9) = 24x" },
                { q: "Desarrolla: (x + y)¬≤ - (x - y)¬≤", a: "4xy", sol: "(x¬≤+2xy+y¬≤) - (x¬≤-2xy+y¬≤) = 4xy" },
                { q: "Simplifica: (2a + b)¬≤ + (2a - b)¬≤", a: "8a¬≤+2b¬≤", sol: "(4a¬≤+4ab+b¬≤) + (4a¬≤-4ab+b¬≤) = 8a¬≤ + 2b¬≤" },
                // NUEVO: Con fracciones y varias letras
                { q: "Desarrolla: (a/2 + b/3)¬≤ - (a/2 - b/3)¬≤", a: "2ab/3", sol: "(a¬≤/4+ab/3+b¬≤/9) - (a¬≤/4-ab/3+b¬≤/9) = 2ab/3" },
                { q: "Calcula: (x¬≤y/3 + z/4)¬≤ + (x¬≤y/3 - z/4)¬≤", a: "2x‚Å¥y¬≤/9+z¬≤/8", sol: "(x‚Å¥y¬≤/9+x¬≤yz/6+z¬≤/16) + (x‚Å¥y¬≤/9-x¬≤yz/6+z¬≤/16) = 2x‚Å¥y¬≤/9 + z¬≤/8" }
            ],

            // BLOQUE 5: DIVISI√ìN Y FACTORIZACI√ìN
            "5-5.1": [
                { q: "Divide: 12x¬≥ : 3x", a: "4x¬≤", sol: "12x¬≥ : 3x = 4x¬≤" },
                { q: "Divide: -20x‚Å¥ : 4x¬≤", a: "-5x¬≤", sol: "-20x‚Å¥ : 4x¬≤ = -5x¬≤" },
                { q: "Divide: 15x‚Åµ : (-3x¬≤)", a: "-5x¬≥", sol: "15x‚Åµ : (-3x¬≤) = -5x¬≥" },
                { q: "Divide: 24x‚Å∂ : 6x¬≥", a: "4x¬≥", sol: "24x‚Å∂ : 6x¬≥ = 4x¬≥" },
                { q: "Divide: -18x‚Å¥y¬≤ : 3xy", a: "-6x¬≥y", sol: "-18x‚Å¥y¬≤ : 3xy = -6x¬≥y" }
            ],
            "5-5.2": [
                { q: "Divide: (10x¬≥ - 15x¬≤) : 5x", a: "2x¬≤-3x", sol: "10x¬≥:5x - 15x¬≤:5x = 2x¬≤ - 3x" },
                { q: "Divide: (12x‚Å¥ + 8x¬≥ - 4x¬≤) : 4x¬≤", a: "3x¬≤+2x-1", sol: "12x‚Å¥:4x¬≤ + 8x¬≥:4x¬≤ - 4x¬≤:4x¬≤ = 3x¬≤ + 2x - 1" },
                { q: "Divide: (15x‚Å¥ - 10x¬≥ + 5x¬≤) : 5x", a: "3x¬≥-2x¬≤+x", sol: "15x‚Å¥:5x - 10x¬≥:5x + 5x¬≤:5x = 3x¬≥ - 2x¬≤ + x" },
                { q: "Divide: (18x¬≥y - 12x¬≤y + 6xy) : 6xy", a: "3x¬≤-2x+1", sol: "18x¬≥y:6xy - 12x¬≤y:6xy + 6xy:6xy = 3x¬≤ - 2x + 1" }
            ],
            "5-5.3": [
                { q: "Divide: (x¬≤ + 7x + 12) : (x + 3). Cociente:", a: "x+4", sol: "x¬≤ + 7x + 12 = (x+3)(x+4), cociente x+4" },
                { q: "Divide: (x¬≤ - 9) : (x + 3). Cociente:", a: "x-3", sol: "x¬≤ - 9 = (x+3)(x-3), cociente x-3" },
                { q: "Divide: (2x¬≤ + 7x + 3) : (x + 3). Cociente:", a: "2x+1", sol: "2x¬≤ + 7x + 3 = (x+3)(2x+1), cociente 2x+1" },
                { q: "Divide: (x¬≥ - 8) : (x - 2). Cociente:", a: "x¬≤+2x+4", sol: "x¬≥ - 8 = (x-2)(x¬≤+2x+4), cociente x¬≤+2x+4" }
            ],
            "5-5.4": [
                { q: "Divide: (x¬≥ + 2x¬≤ - 5x + 3) : (x¬≤ - 1). Cociente:", a: "x+2", sol: "Cociente: x+2, Resto: -4x+5" },
                { q: "Divide: (2x¬≥ - 3x¬≤ + x - 4) : (x¬≤ + 1). Cociente:", a: "2x-3", sol: "Cociente: 2x-3, Resto: -x-1" },
                { q: "Divide: (x‚Å¥ - 2x¬≤ + 1) : (x¬≤ - 1). Cociente:", a: "x¬≤-1", sol: "Cociente: x¬≤-1, Resto: 0" },
                { q: "Divide: (x¬≥ - 5x¬≤ + 8x - 4) : (x¬≤ - 2x + 1). Cociente:", a: "x-3", sol: "Cociente: x-3, Resto: x-1" }
            ],
            "5-5.5": [
                { q: "Divide por Ruffini: (x¬≥ + 2x¬≤ - 5x - 6) : (x - 2). Cociente:", a: "x¬≤+4x+3", sol: "Ruffini con r=2 ‚Üí cociente x¬≤+4x+3, resto 0" },
                { q: "Divide por Ruffini: (x¬≥ - 6x¬≤ + 11x - 6) : (x - 1). Cociente:", a: "x¬≤-5x+6", sol: "Ruffini con r=1 ‚Üí cociente x¬≤-5x+6, resto 0" },
                { q: "Divide por Ruffini: (2x¬≥ + 3x¬≤ - 8x + 3) : (x + 3). Cociente:", a: "2x¬≤-3x+1", sol: "Ruffini con r=-3 ‚Üí cociente 2x¬≤-3x+1, resto 0" },
                { q: "Divide por Ruffini: (x‚Å¥ - 1) : (x - 1). Cociente:", a: "x¬≥+x¬≤+x+1", sol: "Ruffini con r=1 ‚Üí cociente x¬≥+x¬≤+x+1, resto 0" }
            ],
            "5-5.6": [
                { q: "Factoriza por factor com√∫n: 6x¬≥ + 9x¬≤ - 3x", a: "3x(2x¬≤+3x-1)", sol: "Factor com√∫n 3x ‚Üí 3x(2x¬≤+3x-1)" },
                { q: "Factoriza diferencia de cuadrados: x¬≤ - 25", a: "(x+5)(x-5)", sol: "x¬≤-25 = x¬≤-5¬≤ = (x+5)(x-5)" },
                { q: "Factoriza trinomio cuadrado perfecto: x¬≤ + 6x + 9", a: "(x+3)¬≤", sol: "x¬≤+6x+9 = (x+3)¬≤" },
                { q: "Factoriza: x¬≤ + 5x + 6", a: "(x+2)(x+3)", sol: "N√∫meros 2 y 3: suman 5 y multiplican 6 ‚Üí (x+2)(x+3)" },
                { q: "Factoriza: x¬≤ - x - 12", a: "(x+3)(x-4)", sol: "N√∫meros 3 y -4: suman -1 y multiplican -12 ‚Üí (x+3)(x-4)" },
                { q: "Factoriza completamente: x¬≥ - 4x", a: "x(x+2)(x-2)", sol: "x¬≥-4x = x(x¬≤-4) = x(x+2)(x-2)" },
                { q: "Factoriza por Ruffini: x¬≥ + 2x¬≤ - x - 2", a: "(x+1)(x+2)(x-1)", sol: "Ra√≠ces: x=-1,-2,1 ‚Üí (x+1)(x+2)(x-1)" },
                { q: "Factoriza: 4x¬≤ - 9", a: "(2x+3)(2x-3)", sol: "4x¬≤-9 = (2x)¬≤-3¬≤ = (2x+3)(2x-3)" }
            ]
        };

        const blocks = {
            1: { title: "VALOR NUM√âRICO", subtitle: "Sustituci√≥n y evaluaci√≥n", icon: "üéØ", color: "from-blue-500 to-blue-600" },
            2: { title: "SUMA Y RESTA", subtitle: "Operaciones con polinomios", icon: "‚ûï", color: "from-purple-500 to-purple-600" },
            3: { title: "MULTIPLICACI√ìN", subtitle: "Productos de polinomios", icon: "‚úñÔ∏è", color: "from-green-500 to-green-600" },
            4: { title: "IDENTIDADES NOTABLES", subtitle: "Cuadrados y productos", icon: "‚≠ê", color: "from-pink-500 to-pink-600" },
            5: { title: "DIVISI√ìN Y FACTORIZACI√ìN", subtitle: "Divisi√≥n, Ruffini y factorizaci√≥n", icon: "‚ûó", color: "from-orange-500 to-orange-600" }
        };

        const levelNames = {
            "1": { 
                "1.1": "Polinomios sencillos (grado 2)", 
                "1.2": "Polinomios de grado 3", 
                "1.3": "Con coeficientes mixtos", 
                "1.4": "Polinomios complejos (grado 4-5)",
                "1.5": "Evaluaci√≥n con fracciones (x=1/2, etc.)"
            },
            "2": { 
                "2.1": "Operaciones b√°sicas", 
                "2.2": "Con nomenclatura P(x), Q(x)", 
                "2.3": "Tres polinomios", 
                "2.4": "Operaciones combinadas" 
            },
            "3": { 
                "3.1": "Monomio por monomio", 
                "3.2": "Monomio por polinomio", 
                "3.3": "Binomio por binomio", 
                "3.4": "Casos complejos" 
            },
            "4": { 
                "4.1": "Cuadrado de suma (a+b)¬≤", 
                "4.2": "Cuadrado de diferencia (a-b)¬≤", 
                "4.3": "Suma por diferencia (a+b)(a-b)", 
                "4.4": "Identidades combinadas" 
            },
            "5": { 
                "5.1": "Divisi√≥n de monomios", 
                "5.2": "Polinomio entre monomio", 
                "5.3": "Divisi√≥n con binomio", 
                "5.4": "Divisiones con resto",
                "5.5": "Divisi√≥n por Ruffini",
                "5.6": "Factorizaci√≥n de polinomios"
            }
        };

        // Estado
        const state = {
            selectedBlock: null,
            selectedLevel: null,
            answers: {},
            showResults: {},
            studentName: localStorage.getItem('studentName') || '',
            statistics: JSON.parse(localStorage.getItem('polyStatistics') || '{}'),
            levelProgress: JSON.parse(localStorage.getItem('polyProgress') || '{}'),
            startTime: Date.now(),
            showReport: false,
            showResetModal: false
        };

        function saveState() {
            localStorage.setItem('studentName', state.studentName);
            localStorage.setItem('polyStatistics', JSON.stringify(state.statistics));
            localStorage.setItem('polyProgress', JSON.stringify(state.levelProgress));
        }

        function normalizeAnswer(answer) {
            if (!answer) return '';
            let normalized = answer.toLowerCase().trim();
            normalized = normalized.replace(/\s+/g, '');
            normalized = normalized.replace(/\^/g, '').replace(/¬≤/g, '2').replace(/¬≥/g, '3').replace(/‚Å¥/g, '4').replace(/‚Åµ/g, '5').replace(/\*/g, '');
            
            if (normalized.startsWith('(') && normalized.endsWith(')') && !normalized.includes(')(')) {
                const withoutParen = normalized.slice(1, -1);
                if (!withoutParen.includes('(') && !withoutParen.includes(')')) {
                    normalized = withoutParen;
                }
            }
            
            return normalized;
        }

        function checkAnswer(key, correct) {
            const userAnswer = normalizeAnswer(state.answers[key] || '');
            const correctAnswer = normalizeAnswer(correct);
            
            let isCorrect = userAnswer === correctAnswer;
            
            if (!isCorrect && correct.includes('(') && (state.answers[key] || '').includes('(')) {
                const extractFactors = (str) => {
                    const factors = str.match(/\([^)]+\)/g) || [];
                    return factors.sort().join('');
                };
                const userFactors = extractFactors(state.answers[key]);
                const correctFactors = extractFactors(correct);
                isCorrect = userFactors === correctFactors;
            }
            
            state.showResults[key] = { correct: isCorrect };
            
            const parts = key.split('-');
            const statKey = parts[0] + '-' + parts[1];
            
            if (!state.statistics[statKey]) state.statistics[statKey] = { total: 0, correct: 0 };
            if (!state.levelProgress[statKey]) state.levelProgress[statKey] = {};
            
            if (state.levelProgress[statKey][key] === undefined) {
                state.statistics[statKey].total++;
                if (isCorrect) state.statistics[statKey].correct++;
                state.levelProgress[statKey][key] = isCorrect;
                saveState();
            }
            render();
        }

        function getTimeSpent() {
            return Math.floor((Date.now() - state.startTime) / 60000);
        }

        function generateReport() {
            let totalExercises = 0, totalCorrect = 0, byBlock = {};
            Object.entries(state.statistics).forEach(([key, stats]) => {
                totalExercises += stats.total;
                totalCorrect += stats.correct;
                const blockId = key.split('-')[0];
                if (!byBlock[blockId]) byBlock[blockId] = { total: 0, correct: 0 };
                byBlock[blockId].total += stats.total;
                byBlock[blockId].correct += stats.correct;
            });
            const percentage = totalExercises > 0 ? ((totalCorrect / totalExercises) * 100).toFixed(1) : 0;
            return { totalExercises, totalCorrect, percentage, timeSpent: getTimeSpent(), byBlock };
        }

        function renderFractions(text) {
            const MARKER = '¬ß¬ß¬ßFRAC';
            let result = text;
            let fractionCounter = 0;
            const fractions = [];
            
            result = result.replace(/([0-9a-z¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ]+)\/([0-9]+)/gi, (match, numerator, denominator) => {
                const html = `<span class="frac"><span class="top">${numerator}</span><span class="bottom">${denominator}</span></span>`;
                fractions.push(html);
                return `${MARKER}${fractionCounter++}¬ß¬ß¬ß`;
            });
            
            fractions.forEach((html, index) => {
                result = result.replace(`${MARKER}${index}¬ß¬ß¬ß`, html);
            });
            
            return result;
        }

        function render() {
            const app = document.getElementById('app');
            if (!state.studentName) {
                app.innerHTML = `<div class="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <div class="text-6xl text-center mb-4">üìö</div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">¬°Bienvenido!</h2>
                        <p class="text-gray-600 mb-6 text-center">Pr√°ctica de Polinomios - 4¬∫ ESO</p>
                        <p class="text-gray-700 mb-4">Por favor, introduce tu nombre completo:</p>
                        <input type="text" id="nameInput" placeholder="Tu nombre y apellidos" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none mb-4">
                        <button onclick="setName()" class="w-full px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 transition font-medium">Comenzar Pr√°ctica</button>
                    </div></div>`;
                return;
            }

            const report = generateReport();
            app.innerHTML = `<div class="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 p-4">
                ${state.showResetModal ? renderResetModal() : ''}
                ${state.showReport ? renderReport(report) : ''}
                <div class="max-w-7xl mx-auto no-print">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-2xl p-8 mb-8 text-white">
                        <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
                            <div class="flex items-center gap-4">
                                <div class="text-5xl">üìö</div>
                                <div>
                                    <h1 class="text-4xl font-bold mb-2">Polinomios 4¬∫ ESO</h1>
                                    <p class="text-indigo-100 text-lg">Pr√°ctica Interactiva üöÄ</p>
                                    <p class="text-indigo-200 text-sm mt-1">üë§ ${state.studentName}</p>
                                </div>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                ${(state.selectedBlock || state.selectedLevel) ? '<button onclick="goHome()" class="bg-white text-indigo-600 px-4 py-2 rounded-xl hover:bg-indigo-50 transition shadow-lg font-medium">üè† Inicio</button>' : ''}
                                <button onclick="showResetModal()" class="bg-orange-500 text-white px-4 py-2 rounded-xl hover:bg-orange-600 transition shadow-lg font-medium">üîÑ Reiniciar</button>
                                <button onclick="showReport()" class="bg-white text-indigo-600 px-4 py-2 rounded-xl hover:bg-indigo-50 transition shadow-lg font-medium">üìä Informe</button>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-6 flex-wrap">
                            <div class="bg-white bg-opacity-20 px-4 py-2 rounded-lg backdrop-blur"><span class="font-semibold">‚è±Ô∏è ${report.timeSpent} min</span></div>
                            ${report.totalExercises > 0 ? `<div class="bg-green-500 bg-opacity-90 px-4 py-2 rounded-lg backdrop-blur"><span class="font-semibold">‚úÖ ${report.totalCorrect}/${report.totalExercises}</span></div>
                            <div class="bg-yellow-400 bg-opacity-90 px-4 py-2 rounded-lg backdrop-blur"><span class="font-semibold text-gray-800">üìä ${report.percentage}% acierto</span></div>` : ''}
                        </div>
                    </div>
                    ${renderContent()}
                </div></div>`;
        }

        function renderContent() {
            if (!state.selectedBlock) return renderBlockSelection();
            else if (!state.selectedLevel) return renderLevelSelection();
            else return renderExercises();
        }

        function renderBlockSelection() {
            return `<div><h2 class="text-2xl font-bold text-gray-800 mb-6">üèÜ Selecciona un Bloque Tem√°tico</h2>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${Object.entries(blocks).map(([id, block]) => `<div onclick="selectBlock('${id}')" class="bg-gradient-to-br ${block.color} rounded-2xl shadow-xl p-6 cursor-pointer transform transition-all duration-300 hover:scale-105 text-white">
                        <div class="text-5xl mb-4">${block.icon}</div>
                        <h3 class="font-bold text-xl mb-1">${block.title}</h3>
                        <p class="text-white text-opacity-90 text-sm mb-4">${block.subtitle}</p>
                        <div class="flex items-center text-white font-medium">Comenzar ‚Üí</div>
                    </div>`).join('')}
                </div></div>`;
        }

        function renderLevelSelection() {
            const block = blocks[state.selectedBlock];
            return `<div>
                <button onclick="backToBlocks()" class="mb-6 px-6 py-3 bg-white rounded-xl hover:bg-gray-50 transition shadow-lg">‚Üê Volver</button>
                <div class="bg-gradient-to-r ${block.color} rounded-2xl shadow-xl p-8 mb-8 text-white">
                    <h2 class="text-3xl font-bold">${block.title}</h2>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    ${Object.entries(levelNames[state.selectedBlock] || {}).map(([levelId, levelName]) => {
                        const statKey = state.selectedBlock + '-' + levelId;
                        const stats = state.statistics[statKey];
                        const hasStats = stats && stats.total > 0;
                        const pct = hasStats ? ((stats.correct / stats.total) * 100).toFixed(0) : 0;
                        return `<div onclick="selectLevel('${levelId}')" class="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-2xl transition-all">
                            <div class="flex justify-between items-center mb-3">
                                <span class="bg-green-500 text-white px-4 py-1 rounded-full text-sm font-bold">Nivel ${levelId}</span>
                                ${hasStats ? `<span class="text-sm font-bold text-green-600">${stats.correct}/${stats.total}</span>` : ''}
                            </div>
                            <h3 class="font-bold text-xl text-gray-800 mb-2">${levelName}</h3>
                            ${hasStats ? `<div class="mt-2"><div class="w-full bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full bg-green-500" style="width: ${pct}%"></div></div></div>` : ''}
                        </div>`;
                    }).join('')}
                </div></div>`;
        }

        function renderExercises() {
            const exercises = exerciseData[`${state.selectedBlock}-${state.selectedLevel}`] || [];
            return `<div>
                <div class="flex gap-2 mb-6 flex-wrap">
                    <button onclick="backToLevels()" class="px-4 py-2 bg-white rounded-lg shadow hover:bg-gray-50">‚Üê Niveles</button>
                    <button onclick="goHome()" class="px-4 py-2 bg-white rounded-lg shadow hover:bg-gray-50">üè† Inicio</button>
                </div>
                <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                    <h2 class="text-2xl font-bold text-indigo-900">Nivel ${state.selectedLevel}: ${levelNames[state.selectedBlock]?.[state.selectedLevel]}</h2>
                    <p class="text-gray-600 mt-2">${exercises.length} ejercicios</p>
                </div>
                <div class="space-y-6">
                    ${exercises.map((ex, idx) => {
                        const key = `${state.selectedBlock}-${state.selectedLevel}-${idx}`;
                        const result = state.showResults[key];
                        return `<div class="bg-white border-2 rounded-xl p-6">
                            <div class="flex items-start gap-4">
                                <span class="bg-indigo-100 text-indigo-800 px-4 py-2 rounded-full font-bold">#${idx + 1}</span>
                                <div class="flex-1">
                                    <div class="text-xl font-medium mb-4">${renderFractions(ex.q)}</div>
                                    <div class="flex gap-2 flex-wrap">
                                        <input type="text" id="answer-${key}" onchange="updateAnswer('${key}', this.value)" placeholder="Tu respuesta" class="flex-1 min-w-[200px] px-4 py-3 border-2 rounded-lg focus:border-indigo-500 outline-none">
                                        <button onclick="checkAnswer('${key}', '${ex.a}')" class="px-8 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">Comprobar</button>
                                    </div>
                                    ${result ? `<div class="mt-4 p-4 rounded-lg ${result.correct ? 'bg-green-50 border-2 border-green-300' : 'bg-red-50 border-2 border-red-300'}">
                                        <div class="flex items-center gap-2 mb-2">
                                            ${result.correct ? '<span class="text-2xl">‚úÖ</span><span class="font-bold text-green-800">¬°Correcto! üéâ</span>' : '<span class="text-2xl">‚ùå</span><span class="font-bold text-red-800">Incorrecto</span>'}
                                        </div>
                                        <div class="text-gray-700"><strong>Explicaci√≥n:</strong> ${renderFractions(ex.sol)}</div>
                                    </div>` : ''}
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                </div></div>`;
        }

        function renderReport(report) {
            return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">üèÜ</div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Informe de Progreso</h2>
                        <p class="text-gray-600">Alumno: <strong>${state.studentName}</strong></p>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-blue-600">${report.totalExercises}</div>
                            <div class="text-sm text-gray-600">Ejercicios realizados</div>
                        </div>
                        <div class="bg-green-50 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-green-600">${report.percentage}%</div>
                            <div class="text-sm text-gray-600">Acierto</div>
                        </div>
                        <div class="bg-purple-50 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-purple-600">${report.timeSpent}</div>
                            <div class="text-sm text-gray-600">Minutos trabajados</div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Desglose por Bloques</h3>
                        ${Object.entries(report.byBlock).map(([blockId, data]) => {
                            const pct = data.total > 0 ? ((data.correct / data.total) * 100).toFixed(0) : 0;
                            return `<div class="mb-3">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-medium">${blocks[blockId]?.title}</span>
                                    <span class="text-sm text-gray-600">${data.correct}/${data.total} (${pct}%)</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="h-3 rounded-full bg-gradient-to-r ${blocks[blockId]?.color}" style="width: ${pct}%"></div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="hideReport()" class="flex-1 min-w-[200px] px-6 py-3 bg-gray-200 rounded-xl hover:bg-gray-300 transition font-medium">Continuar</button>
                        <button onclick="goHome(); hideReport()" class="flex-1 min-w-[200px] px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition font-medium">üè† Inicio</button>
                        <button onclick="window.print()" class="flex-1 min-w-[200px] px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition font-medium">üñ®Ô∏è Imprimir</button>
                    </div>
                </div>
            </div>`;
        }

        function renderResetModal() {
            return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                    <div class="text-6xl text-center mb-4">üîÑ</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">¬øReiniciar Progreso?</h2>
                    <p class="text-gray-600 mb-6 text-center">Esto borrar√° todo tu progreso actual (ejercicios, estad√≠sticas, nombre).</p>
                    <div class="flex gap-3">
                        <button onclick="hideResetModal()" class="flex-1 px-6 py-3 bg-gray-200 rounded-xl hover:bg-gray-300 transition font-medium">Cancelar</button>
                        <button onclick="resetProgress()" class="flex-1 px-6 py-3 bg-orange-500 text-white rounded-xl hover:bg-orange-600 transition font-medium">Reiniciar</button>
                    </div>
                </div>
            </div>`;
        }

        // Funciones globales
        window.setName = function() {
            const input = document.getElementById('nameInput');
            if (input && input.value.trim()) {
                state.studentName = input.value.trim();
                saveState();
                render();
            }
        };
        window.selectBlock = id => { state.selectedBlock = id; render(); };
        window.selectLevel = id => { state.selectedLevel = id; render(); };
        window.backToBlocks = () => { state.selectedBlock = null; state.selectedLevel = null; render(); };
        window.backToLevels = () => { state.selectedLevel = null; render(); };
        window.goHome = () => { state.selectedBlock = null; state.selectedLevel = null; render(); };
        window.updateAnswer = (key, value) => { state.answers[key] = value; };
        window.checkAnswer = checkAnswer;
        window.showReport = () => { state.showReport = true; render(); };
        window.hideReport = () => { state.showReport = false; render(); };
        window.showResetModal = () => { state.showResetModal = true; render(); };
        window.hideResetModal = () => { state.showResetModal = false; render(); };
        window.resetProgress = () => {
            state.statistics = {}; 
            state.levelProgress = {}; 
            state.answers = {}; 
            state.showResults = {};
            state.selectedBlock = null; 
            state.selectedLevel = null; 
            state.showResetModal = false; 
            state.studentName = '';
            localStorage.clear(); 
            render();
        };

        document.addEventListener('DOMContentLoaded', render);
        document.addEventListener('keypress', e => { 
            if (e.key === 'Enter' && document.getElementById('nameInput')) setName(); 
        });
    </script>
</body>
</html>